<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    

    <title>tensorflow-基于队列和多线程加载数据 | CY的博客</title>
    <meta name="author" content="John Doe">
    
    <meta name="description" content="建立如下的文件 fileslist.csv注：建议采用csv格式，第一列是图像路径，第二列是标签（建议标签预处理成数字），分隔符为 ,

将 fileslist.csv 按行加载到python内置列表，假设为 imgNames# python
with open(&amp;apos;fileslist.cs">
    
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta property="og:title" content="tensorflow-基于队列和多线程加载数据"/>
    <meta property="og:site_name" content="Barwe"/>

    
    <meta property="og:image" content=""/>
    

    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="alternate" href="/atom.xml" title="Barwe" type="application/atom+xml">
    <link rel="stylesheet" href="/css/lib/materialize.min.css">
    <link rel="stylesheet" href="/css/lib/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

    
        <link rel="stylesheet" href="/css/lib/prettify-tomorrow-night-eighties.css" type="text/css">
    
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	
	
</head>


<body>
    <img src="/weixin_favicon.png" style="position: absolute; left: -9999px; opacity: 0; filter: alpha(opacity=0);">

    <nav class="blue-grey">
    <div class="nav-wrapper">
        <a href="#" data-activates="main-menu" class="button-collapse">
            <i class="fa fa-navicon"></i>
        </a>
        <div class="">
            <a href="/" class="brand-logo hide-on-med-and-down">Barwe</a>
            <ul class="right hide-on-med-and-down">
                
                    <li>
                        <a class="menu-home " 
						   href="/" 
						   >
                            <i class="fa fa-home "></i>
							<!-- 在使用自定义的menu时下面的menu.会显示在页面上，原因尚未排查，故而直接注销，有问题再议 -->
							<!--  -->
                            
                            home
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-archive " 
						   href="/archives" 
						   >
                            <i class="fa fa-archive "></i>
							<!-- 在使用自定义的menu时下面的menu.会显示在页面上，原因尚未排查，故而直接注销，有问题再议 -->
							<!--  -->
                            
                            archives
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-category category-menu" 
						   href="javascript:;" 
						   data-activates="category-menu" >
                            <i class="fa fa-bookmark "></i>
							<!-- 在使用自定义的menu时下面的menu.会显示在页面上，原因尚未排查，故而直接注销，有问题再议 -->
							<!--  -->
                            
                            category
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-reading " 
						   href="/reading" 
						   >
                            <i class="fa fa-book "></i>
							<!-- 在使用自定义的menu时下面的menu.会显示在页面上，原因尚未排查，故而直接注销，有问题再议 -->
							<!--  -->
                            
                            reading
                        </a>
                    </li>
                
            </ul>
            <div>
    <ul class="side-nav indigo darken-1" id="main-menu">
        
        <li class="side-user">
            <div class="row">
                <div class="col s4 no-padding">
                    <img class="avatar-image circle responsive-img" src="http://p33k8pinb.bkt.clouddn.com/18-3-8/42928697.jpg" alt="User Avatar">
                </div>
                <div class="info col s8 valign-wrapper no-padding">
                    <div class="valign">
                        <p class="name">Barwe</p>
                        <p class="desc">迷糊皮皮虾</p>
                    </div>
                </div>
            </div>
        </li>
        

        
            <li class="no-padding">
                <a class="waves-effect menu-home " href="/" >
                    <i class="fa fa-home "></i>
                    
                    Home
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-archive " href="/archives" >
                    <i class="fa fa-archive "></i>
                    
                    Archives
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                    <i class="fa fa-bookmark "></i>
                    
                    Categories
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-reading " href="/reading" >
                    <i class="fa fa-book "></i>
                    
                    Reading
                </a>
            </li>
        
    </ul>

    <ul class="side-nav indigo darken-1" id="category-menu">
    

            

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/statistics/">
                    statistics <span class="right">10</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/algorithms/">
                    algorithms <span class="right">2</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/database-op/">
                    database-op <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/data-processing/">
                    data-processing <span class="right">2</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/debug/">
                    debug <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/deep-learning/">
                    deep-learning <span class="right">4</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/mathematics/">
                    mathematics <span class="right">2</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/network/">
                    network <span class="right">3</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/python/">
                    python <span class="right">8</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/windows10/">
                    windows10 <span class="right">5</span></a>
                </a>
            </li>

        

    </ul>
</div>

        </div>
    </div>
</nav>

<div id="search" class="modal search-modal">
    <div class="row">
        <div class="input-field col s12">
              <input id="search-input" type="text">
              <label for="search-input">Search</label>
        </div>

    </div>
    <div id="search-result" class="search-result col s12">

    </div>
</div>


    <main>
        <div class="container main-container">
    <nav class="page-nav hide-on-small-only">
    <div class="nav-wrapper blue-grey">
        <span class="breadcrumb">Current page(Categories)</span>
        
            
    
    
    <a class="breadcrumb" href="/categories/deep-learning/">deep-learning</a>


        

        
    </div>
</nav>

<article>
    <div class="card">
        <div class="card-content">
            

            <div class="article-title">
                
    
        <h1>tensorflow-基于队列和多线程加载数据</h1>
    


            </div>
            <time class="pink-link-context" datetime="2018-01-26T03:18:29.000Z"><a href="/deep-learning/20180126-f29a.html">2018-01-26</a></time>

            <span id="busuanzi_container_page_pv" class="read-times-container">
    <i class="fa fa-eye"></i>
    <span id="busuanzi_value_page_pv"></span>
</span>

            

            <div class="toc pink-link-context hide-on-med-and-down">
    <ol class="section table-of-contents"><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#建立如下的文件-fileslist-csv"><span class="section table-of-contents-text">建立如下的文件 fileslist.csv</span></a></li><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#将-fileslist-csv-按行加载到python内置列表，假设为-imgNames"><span class="section table-of-contents-text">将 fileslist.csv 按行加载到python内置列表，假设为 imgNames</span></a></li><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#建立文件名队列"><span class="section table-of-contents-text">建立文件名队列</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#建队"><span class="section table-of-contents-text">建队</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#出队"><span class="section table-of-contents-text">出队</span></a></li></ol></li><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#单个记录-item-数据标准化：根据图像-路径字符串-解析出-数组"><span class="section table-of-contents-text">单个记录(item)数据标准化：根据图像 路径字符串 解析出 数组</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#对记录-item-解码得到路径-img-path-和标签-img-label"><span class="section table-of-contents-text">对记录 item 解码得到路径 img_path 和标签 img_label</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#解析-img-path-的内容"><span class="section table-of-contents-text">解析 img_path 的内容</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#对图像内容字符串-img-str-进行解析，获取图像的数字信息"><span class="section table-of-contents-text">对图像内容字符串 img_str 进行解析，获取图像的数字信息</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#由flatten化的数字信息确定图像矩阵尺寸（说白了就是reshape）"><span class="section table-of-contents-text">由flatten化的数字信息确定图像矩阵尺寸（说白了就是reshape）</span></a></li></ol></li><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#获取批次数据（batch-subset）"><span class="section table-of-contents-text">获取批次数据（batch subset）</span></a></li><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#Session里面如何使用开启队列？"><span class="section table-of-contents-text">Session里面如何使用开启队列？</span></a></li></ol>
</div>


            <div class="entry pink-link-context">
                <h1 id="建立如下的文件-fileslist-csv"><a href="#建立如下的文件-fileslist-csv" class="headerlink" title="建立如下的文件 fileslist.csv"></a>建立如下的文件 <code>fileslist.csv</code></h1><p><img src="http://p33k8pinb.bkt.clouddn.com/18-1-26/36410313.jpg" alt=""><br><br><strong>注</strong>：建议采用<a href="https://baike.baidu.com/item/CSV/10739" target="_blank" rel="noopener">csv格式</a>，第一列是图像路径，第二列是标签（建议标签预处理成数字），分隔符为 <code>,</code></p>
<hr>
<h1 id="将-fileslist-csv-按行加载到python内置列表，假设为-imgNames"><a href="#将-fileslist-csv-按行加载到python内置列表，假设为-imgNames" class="headerlink" title="将 fileslist.csv 按行加载到python内置列表，假设为 imgNames"></a>将 <code>fileslist.csv</code> 按行加载到python内置列表，假设为 <code>imgNames</code></h1><pre><code># python
with open(&apos;fileslist.csv&apos;,&apos;r&apos;) as fin:
    imgNames = fin.read().strip().split(&apos;\n&apos;)
</code></pre><hr>
<h1 id="建立文件名队列"><a href="#建立文件名队列" class="headerlink" title="建立文件名队列"></a>建立文件名队列</h1><h2 id="建队"><a href="#建队" class="headerlink" title="建队"></a>建队</h2><pre><code>#python
fn_queue = tf.train.string_input_producer(imgNames)
#Other opt-parameters
#    num_epochs: 读取文件一次为一个epoch，默认无限次读取
#    shuffle: 读取文件时是否乱序
#    seed: 当shuffle为True时设置随机数种子(可选)
#    capacity: 队列容量，默认为32(很显然需要大于batch-size)
#    share_name, name, cancel_op
</code></pre><h2 id="出队"><a href="#出队" class="headerlink" title="出队"></a>出队</h2><pre><code>#python
item = fn_queue.dequeue()
</code></pre><p><strong>注</strong>：    <br></p>
<ol>
<li>出队的只是一个符号(参考tensorflow计算图的概念)，真正的值要在Session中获取<br></li>
<li>此时 <code>item</code> 相当于 <code>fileslist.csv</code> 中的一行（一个记录），每个记录具有相同的形式！<br></li>
<li>显然 <code>item</code> 不是标准形式，还需要在后面进行进一步加工</li>
</ol>
<hr>
<h1 id="单个记录-item-数据标准化：根据图像-路径字符串-解析出-数组"><a href="#单个记录-item-数据标准化：根据图像-路径字符串-解析出-数组" class="headerlink" title="单个记录(item)数据标准化：根据图像 路径字符串 解析出 数组"></a>单个记录(<code>item</code>)数据标准化：根据图像 <em>路径字符串</em> 解析出 <em>数组</em></h1><h2 id="对记录-item-解码得到路径-img-path-和标签-img-label"><a href="#对记录-item-解码得到路径-img-path-和标签-img-label" class="headerlink" title="对记录 item 解码得到路径 img_path 和标签 img_label"></a>对记录 <code>item</code> 解码得到路径 <code>img_path</code> 和标签 <code>img_label</code></h2><pre><code>#python
img_path, img_label = tf.decode_csv(item, [[&apos;&apos;],[1]], field_delim=&apos;,&apos;)
</code></pre><p><em>参数解释</em></p>
<ul>
<li><code>records</code> : 必须参数，字符串类型的张量，这里就是 <code>fn_queue</code> 出队的结果 <code>item</code></li>
<li><code>record_defaults</code> : 必须参数，指定返回值的类型(这里返回值类型的定义很有意思~~)<br>这里直观返回值类型为 <code>str, int</code> , 因此形参赋值 <code>[[&#39;&#39;], [1]]</code> (惊奇)<br>第一个 <code>[]</code> 内可以是任意 <code>str</code> 对象，第二个 <code>[]</code> 内可以是任意 <code>int</code> 对象</li>
<li><code>field_delim</code> : 建议显示声明，csv文件列间分隔符，默认为 <code>,</code></li>
<li><code>use_quote_delim</code> : unknown, unimportant</li>
<li><code>name</code></li>
<li><code>na_value</code> : NA/NaN格式选择，没啥用</li>
</ul>
<h2 id="解析-img-path-的内容"><a href="#解析-img-path-的内容" class="headerlink" title="解析 img_path 的内容"></a>解析 <code>img_path</code> 的内容</h2><pre><code>img_str = tf.read_file(img_path)
</code></pre><p><img src="http://p33k8pinb.bkt.clouddn.com/18-1-26/54604707.jpg" style="width:30px;margin:0;display:inline-block"><br><span style="display:inline-block;position:relative;top:-55px;left:40px"><code>img_dtr</code> 实际上还是一个字符串，与包含<strong>文件名内容</strong>的 <code>img_path</code> 不同,<br><code>img_str</code> 包含的是<strong>文件内容</strong><span></span></span></p>
<h2 id="对图像内容字符串-img-str-进行解析，获取图像的数字信息"><a href="#对图像内容字符串-img-str-进行解析，获取图像的数字信息" class="headerlink" title="对图像内容字符串 img_str 进行解析，获取图像的数字信息"></a>对图像内容字符串 <code>img_str</code> 进行解析，获取图像的<strong>数字</strong>信息</h2><pre><code>img_data = tf.image.decode_jpeg(img_str, channels=3)
</code></pre><p><em>参数解释</em></p>
<ul>
<li><code>content</code> : 必须，字符串张量，此处为 <code>img_str</code></li>
<li><code>channels=0</code> ： <span style="color:red">必须指定</span>，常见图像通道数可能取值有 1, 3, 4</li>
<li><code>ratio=1</code></li>
<li><code>fancy_upscaling=True</code></li>
<li><code>try_recover_truncated=False</code></li>
<li><code>acceptable_fraction=1</code></li>
<li><code>dct_method=&#39;&#39;</code></li>
<li><code>name=None</code></li>
</ul>
<h2 id="由flatten化的数字信息确定图像矩阵尺寸（说白了就是reshape）"><a href="#由flatten化的数字信息确定图像矩阵尺寸（说白了就是reshape）" class="headerlink" title="由flatten化的数字信息确定图像矩阵尺寸（说白了就是reshape）"></a>由flatten化的数字信息确定图像矩阵尺寸（说白了就是reshape）</h2><pre><code>img_array = tf.image.resize_images(img_data, [HEIGHT， WIDTH])
</code></pre><p><em>可选参数</em></p>
<ul>
<li><code>method=ResizeMethod.BILINEAR</code> : 变形方法</li>
<li><code>align_corners=False</code></li>
</ul>
<p><img src="http://p33k8pinb.bkt.clouddn.com/18-1-26/54604707.jpg" style="width:30px;margin:0;display:inline-block"><br><span style="display:inline-block;position:relative;top:-55px;left:40px">此处图片的尺寸应写为[高，宽], 即<strong>行</strong>作为数组的第一维度<br><span></span></span></p>
<hr>
<h1 id="获取批次数据（batch-subset）"><a href="#获取批次数据（batch-subset）" class="headerlink" title="获取批次数据（batch subset）"></a>获取批次数据（batch subset）</h1><pre><code>images, labels = tf.train.shuffle_batch([img_array, img_label], 
                                        batch_size=8, 
                                        capacity=100, 
                                        min_after_dequeue=20)
</code></pre><p><em>完整参数解释</em></p>
<ul>
<li><code>tensors</code> : 必须，待打包的记录列表，此处为 <code>[img_array, img_label]</code><br>因为 <code>img_array</code> 和 <code>img_label</code> 在这里都只是个符号，也就不难理解上述赋值了~</li>
<li><code>batch_size</code> : 必须，与训练过程的 <code>batch_size</code> 相同<br>因此在使用队列训练模型时，<code>batch_size</code>需要作为超参进行预赋值</li>
<li><code>capacity</code> : 建议，队列容量<br>注意这里的队列与前面的<strong>文件名队列</strong>不同</li>
<li><code>min_after_dequeue</code> : 建议，每次出队后队列中剩余的记录<br>此参数可用来衡量shuffle水平，剩余记录数量越大，shuffle程度越高</li>
<li><code>num_threads=1</code> ： 可选，入队线程数，通常情况下1个就够用了</li>
<li><code>seed=None</code> : 可选，设置shuffle随机种子</li>
<li><code>enqueue_many=False</code> : 可选，一个记录一个记录的入队还是多个一起入队</li>
<li><code>shapes=None</code></li>
<li><code>allow_smaller_final_batch=False</code> : 当每个epoch最后一个batch数目不足时是否允许灵活调整batch大小</li>
<li><code>share_name=None</code> : 多个Session共用数据加载队列时使用，一般用不上</li>
<li><code>name=None</code></li>
</ul>
<hr>
<p><br><br>然而，以上都是在定义队列加载的<strong>图</strong> 。。。</p>
<h1 id="Session里面如何使用开启队列？"><a href="#Session里面如何使用开启队列？" class="headerlink" title="Session里面如何使用开启队列？"></a><span id="start_queue">Session里面如何使用开启队列？</span></h1><pre><code>with tf.Session(...) as sess:
    coord = tf.train.Coordinator()
    threads = tf.train.start_queue_runners(sess=sess, coord=coord)
    sess.run(tf.global_variables_initializer())
    X, y = sess.run([images, labels])
    利用feed_dict传入X,y进行训练...
    coord.request_stop()
    coord.join(threads=threads)
</code></pre><hr>
<p style="font-size:16px;margin:0">Author: Barwe(YinChen)<br>Email: <a href="mailto:995488247@qq.com" target="_blank" rel="noopener">995488247@qq.com</a><br>本文地址: <a href="http://barwe.top/deep-learning/2018-01-26/20180126111829/" target="_blank" rel="noopener">http://barwe.top/deep-learning/2018-01-26/20180126111829/</a></p>
                
<p class="pink-link-context">
    <a href="/python/20180201-ffef.html" rel="next" title="python自用进度条">
    Prev: python自用进度条
  </a>
</p>



<p class="pink-link-context">
    <a href="/windows10/20180125-f59f.html" rel="next" title="win10系统将C盘的用户文件夹迁移至D盘">
    Next: win10系统将C盘的用户文件夹迁移至D盘
  </a>
</p>


            </div>
			
        </div>
    </div>
</article>






</div>

        <div class="fixed-action-btn float-sitemap">
    <a class="btn-floating btn-large pink">
      <i class="fa fa-caret-square-o-up"></i>
    </a>
    <ul>
      <li><a class="btn-return-top btn-floating waves-effect green" title="Return to top"><i class="fa fa-arrow-circle-o-up"></i></a></li>
      <li><a class="btn-floating waves-effect button-collapse yellow darken-1"  data-activates="main-menu" title="Menu"><i class="fa fa-navicon"></i></a></li>
    </ul>
  </div>

    </main>
    <footer class="page-footer blue-grey darken-1">
    
		<div class="footer-container container">
			<div class="row">
			
				
					<div class="social-group col m4 s12">
						<h5 class="white-text">Social</h5>
						
							<a class="social-link" href="http://weibo.com/dangercy1314" target="_blank">
								<i class="fa fa-2x fa-weibo"></i>
								<!-- <i class="fa fa-2x fa-cat"></i> -->
							</a>
						
							<a class="social-link" href="https://github.com/barwe" target="_blank">
								<i class="fa fa-2x fa-github"></i>
								<!-- <i class="fa fa-2x fa-cat"></i> -->
							</a>
						
						

					</div>
				

				
					<div class="col m8 s12">
						<h5 class="white-text">Links</h5>
						
							<a class="social-link" href="https://music.163.com/#/user/home?id=1514463016" target="_blank">网易云音乐</a>
						
							<a class="social-link" href="http://www.zgshige.com/c/2018-10-19/7451277.shtml" target="_blank">中国诗歌网</a>
						
					</div>
				
			</div>
		</div>
    
</footer>


    <noscript>
    <div class="noscript">
        <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
    </div>
</noscript>
<div class="noscript">
    <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
</div>


<script src="/js/jquery.min.js"></script>
<script src="/js/materialize.min.js"></script>

<script>
    (function($) {
        $(document).ready(function() {
            // 隐藏禁用javascript（针对微信内置浏览器）的提示
            $('.noscript').hide();

            // 图片缩放效果
            var $imgs = $('img').not('.slider-image').not('.avatar-image').not('.carousel-image').not('.card-cover-image').not('.qrcode');

            // 给图片加上点击放大效果（materialbox插件）
            $imgs.addClass('materialboxed').each(function(i, el) {
                $(this).attr('data-caption', $(this).attr('alt') || ' ');
            }).materialbox();

            // 优化表格的显示
            $('table').each(function() {
                var $table = $(this);
                // 除去多行代码的情况
                if ($table.find('pre').length == 0) {
                    $table.addClass('responsive-table striped bordered');
                }
            });

            // 首页幻灯片
            $('.slider').slider({indicators: true, full_width: true, interval: 8000});

            $(".button-collapse").sideNav();
            $(".category-menu").sideNav();

            // 针对gallery post
            $('.carousel').carousel({full_width: true});
            $('.carousel-control.prev').click(function() {
                $('.carousel').carousel('prev');
            });
            $('.carousel-control.next').click(function() {
                $('.carousel').carousel('next');
            });

            // 文章目录
            $('article').not('.simple-article').find('h1').add('h2').add('h3').add('h4').add('h5').add('h6').scrollSpy();

            // 目录随屏幕滚动（防止目录过长越过footer）
            var $toc = $('.toc');
            var scrollTargetTop = 0;
            $(window).scroll(function() {
                var $activeLink = $toc.find('a.active.section');
                if ($(window).scrollTop() < 100) {
                    scrollTargetTop = 0;
                } else {
                    if ($activeLink[0]) {
                        scrollTargetTop = $activeLink.offset().top - $toc.offset().top;
                    }
                }
                $toc.css('top', '-' + scrollTargetTop + 'px');
            });

            // 修正文章目录的left-border颜色
            var color = $('.table-of-contents-text').css('color');
            $('.table-of-contents-link').css('border-left-color', color);

            // 针对移动端做的优化：FAB按钮点击一下收回
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                $('.fixed-action-btn').addClass('click-to-toggle');
            }
            // 回到顶部
            $('.btn-return-top').click(function() {
                $('body, html').animate({
                    scrollTop: 0
                }, 500);
            });

            // 重置读书页面的Tab标签页的颜色
            $('li.tab a').hover(function() {
                $(this).toggleClass('text-lighten-4');
            });
            $('.indicator').addClass('pink lighten-2');

            
            // 添加new标签
            $('').append('<span class="new badge pink"></span>');
            

            // 搜索功能
            $('.modal-trigger').leanModal({
                // 打开搜索框时自动聚焦
                ready: function() {
                    if ($('#search').is(":visible")) {
                        $('#search-input').focus();
                    }
                }
            });
            var searchXml = "";
            if (searchXml.length == 0) {
             	searchXml = "search.xml";
            }
            var searchPath = "/" + searchXml;
            initSearch(searchPath, 'search-input', 'search-result');
        });

        // 初始化搜索与匹配函数
        var initSearch = function(path, search_id, content_id) {
            'use strict';
            $.ajax({
                url: path,
                dataType: "xml",
                success: function(xmlResponse) {
                    // get the contents from search data
                    var datas = $("entry", xmlResponse).map(function() {
                        return {
                            title: $("title", this).text(),
                            content: $("content", this).text(),
                            url: $("url", this).text()
                        };
                    }).get();
                    var $input = document.getElementById(search_id);
                    var $resultContent = document.getElementById(content_id);
                    $input.addEventListener('input', function() {
                        var str = '<ul class=\"search-result-list\">';
                        var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                        $resultContent.innerHTML = "";
                        if (this.value.trim().length <= 0) {
                            return;
                        }
                        // perform local searching
                        datas.forEach(function(data) {
                            var isMatch = true;
                            var content_index = [];
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                            var data_url = data.url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty titles and contents
                            if (data_title != '' && data_content != '') {
                                keywords.forEach(function(keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);
                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i == 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            }
                            // show search results
                            if (isMatch) {
                                keywords.forEach(function(keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    data_title = data_title.replace(regS, "<span class=\"search-keyword pink lighten-2\">" + keyword + "</span>");
                                });

                                str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 100 characters
                                    var start = first_occur - 20;
                                    var end = first_occur + 80;
                                    if (start < 0) {
                                        start = 0;
                                    }
                                    if (start == 0) {
                                        end = 100;
                                    }
                                    if (end > content.length) {
                                        end = content.length;
                                    }
                                    var match_content = content.substring(start, end);
                                    // highlight all keywords
                                    keywords.forEach(function(keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, "<span class=\"search-keyword pink lighten-2\">" + keyword + "</span>");
                                    });

                                    str += "<p class=\"search-result\">..." + match_content + "...</p>"
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        $resultContent.innerHTML = str;
                    });
                }
            });
        }
    })(jQuery);
</script>


<script src="/js/prettify.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $("pre").addClass("prettyprint");
        prettyPrint();
    });
</script>




<script type="text/javascript" src="http://tajs.qq.com/stats?sId=65955364" charset="UTF-8"></script>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>
<script type="text/javascript" async
  src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>



</body>
</html>
